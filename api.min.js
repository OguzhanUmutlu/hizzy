const fs=require("fs"),https=require("https"),http=require("http"),path=require("path"),mime=require("mime"),os=require("os"),exec=require("child_process")["exec"],stdin=process["stdin"],EventEmitter=require("events")["EventEmitter"],WS=require("ws"),open=require("open"),babel=require("@babel/core"),babelParser=require("@babel/parser"),traverse=require("@babel/traverse").default,minify={js:(...e)=>require("uglify-js").minify(...e).code,css:(...e)=>require("csso").minify(...e).css,html:(...e)=>require("html-minifier-terser").minify(...e)},xss=require("xss"),url=require("url"),exit=(...e)=>{printer.dev.error(...e),process.exit(1)},random=(process.on("exit",()=>{if(global.Hizzy){var e=Hizzy.getAddons();for(const t in e)e[t]&&e[t].module&&"function"==typeof e[t].module.disable&&e[t].module.disable("termination")}}),process.on("SIGINT",()=>{process.exit(0)}),process.on("uncaughtException",e=>{printer.dev.error(e),process.exit(1)}),()=>crypto.getRandomValues(new Uint32Array([0]))[0].toString(36)),runtimeId=random(),EVERYONE=n=>{if(n.__FUNCTION__)return async(...e)=>{var t={};for(const i of Hizzy.clientUUIDs())t[i]=await Hizzy.sendEvalTo(i,"__hizzy_run"+Hizzy.getHash(i)+"__["+n.__FUNCTION__FILE_J__+"].normal."+n.__FUNCTION__+"("+e.map(e=>JSON.stringify(e)).join(",")+")");return t};throw new Error("EVERYONE function only allows client-sided functions!")},makeClientFunction=(Object.defineProperty(Function.prototype,"everyone",{get:function(){return EVERYONE(this)}}),(e,i,n=null)=>{e=path.join(e);const r=JSON.stringify(e);var t=async(...e)=>{if(null===n)throw new Error("This client-sided function wasn't assigned to any clients! Although you can still use the function with the '.everyone' property of this function!");var t=Hizzy.getHash(n);return Hizzy.sendEvalTo(n,`__hizzy_run${t}__[${r}].normal.${i}(${e.map(e=>JSON.stringify(e)).join(",")})`)};return t.__FUNCTION__=i,t.__FUNCTION__FILE__=e,t.__FUNCTION__FILE_J__=r,t}),makeBeginCode=(t,e,i)=>e.map(e=>`const ${e} = Hizzy.makeClientFunction(${i}, ${JSON.stringify(e)}, ${JSON.stringify(t)});`).join(""),{CLIENT2SERVER,SERVER2CLIENT}={CLIENT2SERVER:{HANDSHAKE_RESPONSE:"0",CLIENT_FUNCTION_RESPONSE:"1",SERVER_FUNCTION_REQUEST:"2",KEEPALIVE:"3",0:"HANDSHAKE_RESPONSE",1:"SERVER_FUNCTION_REQUEST",2:"CLIENT_FUNCTION_RESPONSE",3:"KEEPALIVE"},SERVER2CLIENT:{FILE_REFRESH:"0",HANDSHAKE_REQUESTED:"1",CLIENT_FUNCTION_REQUEST:"2",SERVER_FUNCTION_RESPONSE:"3",SURE_HANDSHAKE:"4",0:"FILE_REFRESH",1:"HANDSHAKE_REQUESTED",2:"CLIENT_FUNCTION_REQUEST",3:"SERVER_FUNCTION_RESPONSE",4:"SURE_HANDSHAKE"}},fx=(e,t)=>{e=(e=e.toString()).split(".");let i=e[1]||"";return i.length>t&&(i=i.substring(0,t)),e[0]+(i?"."+i:"")},timeForm=e=>864e5<=e?fx(e/24/60/60/1e3,3)+"d":36e5<=e?fx(e/60/60/1e3,3)+"h":6e4<=e?fx(e/60/1e3,3)+"m":1e3<=e?fx(e/1e3,3)+"s":e+"ms",ck="__"+__PRODUCT__+"__",jsOpt={mangle:{toplevel:!1}},HIZZY_EXPERIMENTAL=process.argv.includes("--experimental");let experimentalId=Date.now().toString(36),jsxInjection,htmlInjection,preactCode,preactHooksCode;if(HIZZY_EXPERIMENTAL){const D=Date.now();jsxInjection=minify.js(fs.readFileSync(path.join(__dirname,"injections/jsx.js"),"utf8"),jsOpt),fs.writeFileSync(path.join(__dirname,"injections/jsx.min.js"),jsxInjection),htmlInjection=minify.js(fs.readFileSync(path.join(__dirname,"injections/html.js"),"utf8").replace("$CKL",ck.length+1+"").replaceAll("$CK",ck),jsOpt),fs.writeFileSync(path.join(__dirname,"injections/html.min.js"),htmlInjection),(async()=>{preactCode=(await(await fetch("https://esm.sh/stable/preact/es2022/preact.mjs")).text()).replace("sourceMappingURL",""),fs.writeFileSync(path.join(__dirname,"injections/preact.min.js"),preactCode),preactHooksCode=(await(await fetch("https://esm.sh/stable/preact/es2022/hooks.js")).text()).replace("sourceMappingURL","").replace(/"\/stable\/preact@(\d.?)+\/es2022\/preact\.mjs"/,`"./__hizzy__preact__?${experimentalId}"`)+`
import *as React from "./__hizzy__preact__?${experimentalId}"; export{React}`,fs.writeFileSync(path.join(__dirname,"injections/hooks.min.js"),preactHooksCode),fs.writeFileSync(path.join(__dirname,"injections/.last"),experimentalId);var e=Date.now()-D;printer.dev.pass("Experimental initialization. (%c"+timeForm(e)+"&t)","color: orange")})()}else jsxInjection=fs.readFileSync(path.join(__dirname,"injections/jsx.min.js"),"utf8"),htmlInjection=fs.readFileSync(path.join(__dirname,"injections/html.min.js"),"utf8"),preactCode=fs.readFileSync(path.join(__dirname,"injections/preact.min.js"),"utf8"),preactHooksCode=fs.readFileSync(path.join(__dirname,"injections/hooks.min.js"),"utf8"),experimentalId=fs.readFileSync(path.join(__dirname,"injections/.last"),"utf8");const interfaces=os.networkInterfaces(),addresses=[];for(const F in interfaces){const G=interfaces[F];for(const H of G)"IPv4"!==H.family||H.internal||addresses.push(H.address)}class Client{static clients={};__socket;class=Client;attributes={};routes={};constructor(e){if(Client.clients[e._uuid])return Client.clients[e._uuid];this.__socket=e,Client.clients[e._uuid]=this}get uuid(){return this.__socket._uuid}async eval(e){return API.API.sendEvalTo(this.uuid,e)}remove(e="forced"){this.__socket._close(e)}run(e,t,...i){return makeClientFunction(e,t,this.uuid)(...i)}}class Addon{static addons={};#name;#options;#module;#init=!1;static async create(e,t){e=new Addon(e,t);return await e.init(),e}constructor(e,t){if(Addon.addons[e])return Addon.addons[e];(Addon.addons[e]=this).#name=e,this.#options=t}async init(){var t=Date.now();let i=this["name"];if(!this.#init){this.#init=!0;let e=path.join(i,"package.json");i.startsWith("@hizzy/")&&(i=path.join(__dirname,"addons",i.substring(7)),e=path.join(i,"package.json"),i=url.pathToFileURL(i).href);try{if(!fs.existsSync(e)||!fs.statSync(e).isFile())throw new Error("package.json file not found.");var n=JSON.parse(fs.readFileSync(e,"utf8"));this.#module=new(await import(i+path.sep+n.main)).default(n,this.#options)}catch(e){return printer.dev.fail("Failed to require addon: %c"+this.name+"&t, disabling it...","color: orange"),void printer.dev.error(e)}"function"==typeof this.#module.onLoad&&this.#module.onLoad();n=Date.now()-t;printer.dev.pass("Loaded addon: %c"+this.#module.name+"@"+this.#module.version+" &t(%c"+timeForm(n)+"&t)","color: blue","color: orange")}}get options(){return this.#options}get name(){return this.#name}get module(){return this.#module}}class AddonModule{#pkg;#options;constructor(e,t){this.#pkg=e,this.#options=t}get name(){return this.#pkg.name}get description(){return this.#pkg.description}get version(){return this.#pkg.version}get options(){return this.#options}onLoad(){}onEnable(){}onDisable(e){}onClientSideLoad="";onClientSideRendered="";onClientSideError="";disable(e){printer.dev[e?"fail":"debug"]("Disabling addon %c"+this.name+"&t"+(e?" for "+e:"")+"...","color: orange"),this.onDisable()}log(...e){printer.dev.log("["+this.constructor.name+"] ",...e)}}class API extends EventEmitter{static API=null;Addon=Addon;Client=Client;AddonModule=AddonModule;#listening=!1;#realtime=!1;#isBuilding=!1;#isScanningBuild=!1;#dir;#buildCache=null;#blurCache=null;#buildPromise=new Promise(e=>e());#builtAt=null;#buildRuntimeId=null;#scanPromise=new Promise(e=>e());#webUUIDs={};#clients={};#jsxCache={};#jsxFunctions={};#port=-1;#https=conf.https;#serverAddress;#evalId=0;#evalResponses={};#isInputOn=!1;#hashes={};#initFunctions=[];#importMap={};#importMains={};#watchingFiles={};#isInit=!1;#uuidTimeout={};#builtJSXCache={};#builtJSXPage={};#clientPages={};#firstBuild=!0;#firstScan=!0;#addonCache=null;server;socketServer;autoRefresh=!1;dev=!1;customShortcuts={};preRequests=[];constructor(e){if(API.API)return API.API;super(),(API.API=this).#dir=e;e=this.app=require("express")();e.disable("x-powered-by"),this.server=(this.#https?https:http).createServer(e)}async init(){this.#isInit||(this.#isInit=!0,this.app.use(async(t,i,n)=>{i.setHeader("X-Powered-By","Hizzy");var e,r=this.getCookie(t.headers.cookie,ck),s=this.#clients[r];if(printer.dev.debug("request: "+t.url+", method: "+t.method+", ip: "+(t.ip.startsWith("::ffff:")?t.ip.substring(7):t.ip)),!this.dev&&(this.#isBuilding||this.#isScanningBuild))return i.send("Building, please be patient.<script>setTimeout(_=>location.reload(),1000)<\/script>");let o=t.url.split("?")[0];if("/"===o[0]){if(o=o.substring(1),t.__socket=s,t._uuid=r,s&&(s._req=t),s&&o===`__${__PRODUCT__}__addons__`)return t.url.split("?")[1]!==runtimeId?i.redirect("/__"+__PRODUCT__+"__addons__?"+runtimeId):void this.sendRawFile(".json",this.#addonCache,i);if(s&&o.includes("/")&&o.split("/")[0]===`__${__PRODUCT__}__import__`)return i.setHeader("Cache-Control","max-age=31536000,immutable"),(r=o.split("/")[1])?(this.#addImport(r,null,e=[]),e.length?this.sendRawFile(".js",`throw 'Module not found: ${e.join(", ")}'`):this.#importMap[r]&&(e=o.split("/").slice(2).join("/")||this.#importMains[r],r=this.#importMap[r][e])?void this.sendRawFile(e,r,i):void 0):void 0;if(s&&o==="__"+__PRODUCT__+"__preact__")return t.url.split("?")[1]!==experimentalId?void 0:void this.sendRawFile(".js",preactCode,i);if(s&&o==="__"+__PRODUCT__+"__preact__hooks__")return t.url.split("?")[1]!==experimentalId?void 0:void this.sendRawFile(".js",preactHooksCode,i);const a=e=>{if(e===this.preRequests.length)return n();this.preRequests[a](t,i,()=>a(e+1))};await a(0)}}),this.dev&&!fs.existsSync(path.join(this.#dir,conf.srcFolder))&&(printer.dev.warn("No %c/"+conf.srcFolder+"&t found. Forcing to disable the developer mode.","color: orange"),this.dev=!1))}findOptimalFile(e){return fs.existsSync(e)?e:null}cacheDevFile(e){return fs.readFileSync(e)}async cacheBuildFile(e){return this.#buildCache||(await this.#scanPromise,await this.scanBuild()),this.#buildCache[e]}async notFound(e,t){t.headersSent||t.send(`<pre>Not found: ${xss.filterXSS(e.url)}</pre>`)}prepLoad(e,t){e._uuid=t._uuid=crypto.randomUUID(),this.#webUUIDs[e._uuid]=e._Route,t.cookie(ck,t._uuid),0<conf.connectionTimeout&&this.#realtime&&(this.#uuidTimeout[e._uuid]=setTimeout(()=>{delete this.#webUUIDs[e._uuid]},conf.connectionTimeout))}random(){return random()}enableRealtime(){var e;if(!this.#realtime)return this.#realtime=!0,(e=this.socketServer=new WS.WebSocketServer({server:this.server})).on("connection",(p,e)=>{const f=this.getCookie(e.headers.cookie,ck);p._uuid=f;let m={};p._handshook=!1,p._closed=!1,p._req=e,p._actualReq=e;e=this.#clientPages[f]||[];p._clientPages=e[0],p._mainFile=e[1],p._URL_=this.#webUUIDs[f];const _=!!e[0],g=(delete this.#clientPages[f],new Client(p)),v=(p._send=e=>{_argv_["debug-socket"]&&printer.dev.debug("> "+e),p._closed||p.send(e)},clearTimeout(this.#uuidTimeout[f]),p._close=(e,t=!0)=>{if(clearTimeout(S),clearTimeout(n),!p._closed){if(p._handshook&&_&&p._mainFile){var i=p._clientPages[p._mainFile].json.leaveEvent;try{Function("currentUUID","currentClient",`${m[p._mainFile]};${i.map(e=>e.code).join(";")};`+i.map(e=>e.name+"()").join(";"))(f,g)}catch(e){printer.dev.error(e)}}t&&(p.close(),printer.dev.debug("socket remove: "+(p._uuid||"-1")+", "+e)),p._closed=!0,delete this.#clients[f],Client.clients[f]&&delete Client.clients[f]}});let n,t;const y=()=>{conf.keepaliveTimeout<0||!p._URL_.endsWith(".jsx")&&!p._URL_.endsWith(".tsx")||(!t||t+conf.minClientKeepalive<Date.now())&&(clearTimeout(n),t=Date.now(),n=setTimeout(()=>v("couldn't stay alive"),conf.keepaliveTimeout))},S=0<conf.connectionTimeout?setTimeout(e=>v("timeout"),conf.connectionTimeout):null;if(!f||this.#clients[f]||!(f in this.#webUUIDs))return v("invalid key");this.#clients[f]=p,delete this.#webUUIDs[f],printer.dev.debug("socket add: "+f),p._send(SERVER2CLIENT.HANDSHAKE_REQUESTED);const i=()=>p._clientPages&&Object.keys(p._clientPages).forEach(e=>{var t,i;e&&(e.endsWith(".jsx")||e.endsWith(".tsx"))&&(t=p._clientPages[e].json.clientFunctionList,i=JSON.stringify(e),m[e]=makeBeginCode(f,t,i))}),w=(i(),()=>{if(p._mainFile){var e=p._clientPages[p._mainFile].json.joinEvent;try{Function("currentUUID","currentClient",`${m[p._mainFile]};${e.map(e=>e.code).join(";")};`+e.map(e=>e.name+"()").join(";"))(f,g)}catch(e){printer.dev.error(e),v("internal server error")}}});p._externalLoad=(e,t)=>{t&&(p._clientPages=t[0],p._mainFile=t[1],p._URL_=e,i(),w())},y(),p.on("message",async t=>{if(p._closed)return v("bypass attempt");clearTimeout(S);try{if(t=t.toString(),!p._closed){if(_argv_["debug-socket"]&&printer.dev.debug("< "+t),t[0]===CLIENT2SERVER.HANDSHAKE_RESPONSE)return p._handshook?v("one handshake is enough"):(p._handshook=!0,w(),void p._send(SERVER2CLIENT.SURE_HANDSHAKE));if(!p._handshook)return v("haven't handshook");if(p._URL_.endsWith(".jsx")||p._URL_.endsWith(".tsx"))if(t[0]===CLIENT2SERVER.SERVER_FUNCTION_REQUEST){if(!_)return v("unauthorized");var i=t.substring(1).split(":"),n=i[0],r=i[1],s=i[2];if("string"!=typeof m[r]||"object"!=typeof p._clientPages[r])return v("invalid jsx");var o=p._clientPages[r].json.serverFunctions[s];if(!o)return v("invalid function");if(this.#hashes[f]){let e;try{e=JSON.parse(i.slice(3).join(":"))}catch(e){return v("invalid json")}if("object"!=typeof e||!Array.isArray(e))return v("invalid function args");var a=await Function("currentUUID","currentClient","...args",`${m[r]};${o.code};return ${s}(...args)`)(f,g,...e);if(o.r){let t;try{t=JSON.stringify(a)}catch(e){t="undefined",printer.dev.fail("Couldn't stringify the response from the '@server/respond -> "+s+"' function at '/"+p._URL_+"'."),printer.dev.error(e)}p._send(SERVER2CLIENT.SERVER_FUNCTION_RESPONSE+n+":"+t)}}}else if(t[0]===CLIENT2SERVER.CLIENT_FUNCTION_RESPONSE){if(!_)return v("unauthorized");var l="1"===t[1],d=t.substring(2).split(":"),c=d[0];if(!c||!this.#evalResponses[c])return v("invalid eval");var u=d.slice(1).join(":");let e;var h={true:!0,false:!1,null:null,undefined:void 0};try{e=u in h?h[u]:l?new Error(u):JSON.parse(u)}catch(e){return v("invalid json")}this.#evalResponses[c](e),delete this.#evalResponses[c]}else t[0]===CLIENT2SERVER.KEEPALIVE&&y()}}catch(e){printer.dev.error(e),v("internal server error")}}),p.on("close",()=>v("disconnect",!1))}),e}async#builtJSX(t,i,n,r,s,o,a){if(!s[t=path.join(t)]&&!r.headersSent)if(this.#builtJSXCache[t])s[t]=this.#builtJSXCache[t],o[t]=s[t].pk;else{let e;if(this.dev){var l=[];if(i=(e=await this.#pseudoBuildJSX(t,i,null,l)).code,delete e.code,l.length)return printer.dev.fail("A function with the decorator @server/start was found. Please use the main file instead.\n  Note: @server/start decorator can only be used in production mode!"),void r.json({error:"Internal server error"})}else e=this.#jsxFunctions[t];if(e){const d=e.serverFunctions;l=Object.keys(d);if(s[t]={code:i,json:e,pk:{code:i,functions:l.filter(e=>!d[e].r),respondFunctions:l.filter(e=>d[e].r),client:e.clientFunctionList,clientLoad:e.clientLoadFunctionList}},o[t]=s[t].pk,!a){a=n._Allow;const c=n._Deny;if("*"===c)a=[];else if("*"===a)if(this.dev){a=[];const u=e=>{const t=path.join(this.#dir,conf.srcFolder,e),i=fs.readdirSync(t);for(const n of i){const i=path.join(t,n);if(!fs.existsSync(i))return;if(fs.statSync(i).isFile()){const t=(e?e+"/":"")+n;c.includes(t)||a.push(t)}else u((e?e+"/":"")+n)}};u("")}else a=Object.keys(this.#buildCache).filter(e=>!c.includes(e))}for(const h of a){let e;e=(e=this.dev?this.cacheDevFile(path.join(this.#dir,conf.srcFolder,h)):await this.cacheBuildFile(h))||"",h.endsWith(".jsx")||h.endsWith(".tsx")?await this.#builtJSX(h,e,n,r,s,o):(e instanceof Buffer&&(e=[...e]),s[h]=e,o[h]=e)}this.dev||(this.#builtJSXCache[t]=s[t])}else printer.dev.fail("Couldn't find the JSX file in build: "+t),r.json({error:"Internal server error"})}}async renderJSX(e,t,i,n,r=!1){var s;if(!n.headersSent)return this.prepLoad(i,n),s=this.random(),this.#realtime?r?(r=await this.#getPagePacket(e,t,i,n),i.__socket._externalLoad(e,this.#clientPages[i._uuid]),"yes"===i.headers["hizzy-cache"]?n.send("ok"):n.send(i._RouteJSON+"\0"+r)):(this.#hashes[i._uuid]=s,void this.sendRawFile(".html",`<script data-rm=${s} type=module>${jsxInjection.replace("$$R$$",s).replace("$$R$$",s).replace("$$CONF$$","['"+s+"','"+(this.#buildRuntimeId||runtimeId)+"',"+this.#builtAt+","+(0<conf.keepaliveTimeout?conf.clientKeepalive:-1)+","+i._RouteJSON+","+await this.#getPagePacket(e,t,i,n)+","+(this.dev?1:0)+",'"+experimentalId+"']")}</script>`,n)):n.json({error:"Expected 'realtime' option in the 'hizzy.json' to be true."})}async#getPagePacket(e,t,i,n){let r={},s={},o;var a=i.url.split("?")[0];if(this.#builtJSXPage[a])[r,o]=this.#builtJSXPage[a];else{try{await this.#builtJSX(e,t,i,n,r,s)}catch(e){return printer.dev.error(e),void n.json({error:"Internal server error"})}if(n.headersSent)return;o=JSON.stringify(s),this.dev||(this.#builtJSXPage[a]=[r,o])}return this.#clientPages[i._uuid]=[r,path.join(e)],this.#watchFile(i._Route),o}renderHTML(e,t,i,n){this.prepLoad(i,n);var r=this.random();this.#watchFile(i._Route),this.sendRawFile(".html",t+(this.#realtime?`<script data-rm=${r}>`+htmlInjection.replace("$R",r).replace("$T",0<conf.keepaliveTimeout?conf.clientKeepalive:-1)+"<\/script>":""),n)}#watchFile(i){this.dev&&!this.#watchingFiles[i]&&this.autoRefresh&&(i.endsWith(".html")||i.endsWith(".jsx")||i.endsWith(".tsx"))&&(this.#watchingFiles[i]=!0,fs.watchFile(path.join(this.#dir,conf.srcFolder,i),{interval:1},()=>{for(const t in this.#clients){var e=this.#clients[t];if(e._URL_!==i)return;e._send(SERVER2CLIENT.FILE_REFRESH)}}))}sendRawFile(e,t,i){i.headersSent||(i.setHeader("Content-Type",mime.getType(e)),i.send(t))}async sendFile(e,t,i,n,r=!1){var s="script"===i.headers["sec-fetch-dest"]||"script"===i.headers["hizzy-dest"];return s&&!i.__socket?n.json({error:"Unauthorized"}):r||!e.endsWith(".jsx")&&!e.endsWith(".tsx")?r||!e.endsWith(".html")||s?(e.endsWith(".css")&&s&&(e+=".js",t=`let st=document.createElement("style");st.innerHTML=${JSON.stringify(t.toString())};document.head.appendChild(st);export default st`),e.endsWith(".html")&&s&&(t=`export default new DOMParser().parseFromString(${JSON.stringify(t.toString())},"text/html")`,e+=".js"),void this.sendRawFile(e,t,n)):this.renderHTML(e,t,i,n):this.renderJSX(e,t,i,n,s)}#staticRender(e,t){if(0!==Object.keys(conf.static).length){var i=e.url.substring(1).split("?")[0];for(const r in conf.static){var n=path.join(this.#dir,r,conf.static[r],i);if(fs.existsSync(n)&&fs.statSync(n).isFile())return this.sendFile(i,fs.readFileSync(n),e,t,!1)}}return this.notFound(e,t)}#invalidFile(e,t){e.send("Couldn't find the file. "+(this.dev?"File does not exist: "+xss.filterXSS(t):"Please report this to the owner of the web site."))}#devRender(e,t,i){var n=path.join(this.#dir,conf.srcFolder,e);return fs.existsSync(n)?(n=this.cacheDevFile(n))?void this.sendFile(e,n,t,i).then(e=>e):this.#invalidFile(i,e):this.#staticRender(t,i)}async#buildRender(e,t,i){var n=await this.cacheBuildFile(e);if(!n)return this.#invalidFile(i,e);await this.sendFile(e,n,t,i)}#formatLocalURL(e){var t=this.#serverAddress["port"];return`http${this.#https?"s":""}://${e}${80===t?"":":"+t}/`}#sendURLs(){var{address:e,family:t}=this.#serverAddress;printer.raw.log("  %c➜%c  Local:   %c"+this.#formatLocalURL("IPv6"===t?"localhost":e),"color: greenBright","","color: cyan"),_argv_.host?printer.raw.log("  %c➜%c  Network: %c"+addresses.map(e=>this.#formatLocalURL(e)).join(", "),"color: greenBright","","color: cyan"):printer.raw.log("  %c➜  Network: use %c--host%c to expose","color: gray","","color: gray")}openInBrowser(){open("http://localhost:"+this.#port)}async#hasVSC(){return new Promise(t=>exec("code --version",e=>t(!e)))}async listen(){this.#listening&&await new Promise(e=>this.server.close(e)),this.#listening=!1;let t=+_argv_.port;if(t<0&&(t=0),this.#port=t,await new Promise(e=>this.server.listen(t,()=>e(!0))),this.#listening=!0,!this.#isInputOn){this.#isInputOn=!0;const l=this.getAddons();for(const c in l)l[c].module.onEnable();if(!this.#addonCache){const l=this.getAddons();var e=[];for(const u in l){var i=l[u],o=[i.module.name,(i.module.onClientSideLoad||"")+"",(i.module.onClientSideRendered||"")+"",(i.module.onClientSideError||"")+""];if(!o.slice(1).every(e=>!e)){if(!this.dev)for(const h in o)o[h]=o[h]?require("uglify-js").minify(o[h]).code:"";e.push(o)}}this.#addonCache=JSON.stringify(e)}this.#initFunctions.forEach(e=>e());var a=(this.#serverAddress=this.server.address())["port"];this.#port=a,this.dev||printer.println(""),printer.raw.log("  %cHIZZY v"+__VERSION__+"%c  ready in%c "+timeForm(Date.now()-__sT__),"color: yellow","color: gray",""),delete global.__sT__,printer.println(""),printer.inline.log("  %c➜%c  Mode:    %c"+(this.dev?"Development":"Production"),"color: greenBright","","color: "+(this.dev?"orange":"green")),t<=0&&printer.inline.log("%c, randomized port","color: gray"),_argv_.debug&&printer.inline.log("%c, debugging","color: gray"),printer.inline.print("\n"),this.#sendURLs(),printer.raw.log(`  %c➜%c  press %ch%c to show help
`,"color: gray","color: gray","color: whiteBright","color: gray"),stdin.setRawMode(!0),stdin.resume();let n=null,r=null;a=await this.#hasVSC();const d={h:{description:"show this menu",enabled:!0,noRepeat:!0,run:()=>{printer.raw.println(""),printer.raw.log("  Shortcuts");for(const t in d){var e=d[t];e.enabled&&printer.raw.log("%c  press %c"+t+"%c to "+e.description,"color: gray","","color: gray")}printer.raw.println("")}},r:{description:"restart the server",enabled:!0,run:async()=>{this.#listening&&(await this.listen(),printer.raw.log("%c  ➜  Restarted the server.","color: green"))}},b:{description:"build",enabled:!this.dev,run:async()=>{await this.build(),await this.scanBuild()}},s:{description:"re-scan the build",enabled:!this.dev,run:async()=>this.scanBuild()},u:{description:"show server url",enabled:!0,noRepeat:!0,run:()=>{printer.raw.println(""),this.#sendURLs(),printer.raw.println("")}},o:{description:"open in browser",enabled:!0,noRepeat:!0,run:()=>this.openInBrowser()},c:{description:"clear the console",enabled:!0,run:()=>printer.clear()},v:{description:"open VS Code in here",enabled:a,noRepeat:!0,run:async()=>{await(r=new Promise(e=>exec('code "'+this.#dir+'"',e)))?printer.raw.log("%c  ✕  Failed to open VS Code.","color: red"):printer.raw.log("%c  ✓  Opened VS Code!","color: green")}},a:{description:"re-enable all addons",enabled:!0,run:()=>{for(const e in Addon.addons)Addon.addons[e].module.onDisable("shortcut");printer.raw.log("%c  ✓  All addons have been disabled.","color: green");for(const t in Addon.addons)Addon.addons[t].module.onEnable();printer.raw.log("%c  ✓  All addons have been enabled.","color: green")}},q:{description:"quit",enabled:!0,run:()=>{printer.raw.log("%c  ✕  Stopping the process...","color: red; font-weight: bold"),process.exit()}},...this.customShortcuts};let s=null;stdin.on("data",async e=>{if("\f"===(e=e.toString()))return printer.clear();""===e&&(printer.raw.log("%c  ✕  Stopping the process...","color: red; font-weight: bold"),process.exit());var i=d[e];if(i&&(!i.noRepeat||n!==e)){n=e,await this.waitBuild(),await this.waitBuildScanning(),await r,await s;let t;s=new Promise(e=>t=e),await i.run(),t()}}),_argv_.open&&this.openInBrowser()}}async#buildInternal(i,n=[0],r,s,o,a){var e=path.join(this.#dir,conf.srcFolder);for(const m of fs.readdirSync(path.join(e,...i))){var l=path.join(e,...i,m);if(fs.existsSync(l))if(fs.statSync(l).isDirectory())await this.#buildInternal([...i,m],n,r?r.folder(m):null,s.folder(m),o.folder(m),a.folder(m));else{l=fs.readFileSync(l);let e=l,t=!1;var d,c,u,h,p,f=(f=m.split("."))[f.length-1];try{"jsx"===f?(d=await this.readClientJSX(m,l.toString()),e=d.code,delete d.code,o.file(m.substring(0,m.length-4)+".json",JSON.stringify(d))):["html","js","css"].includes(f)?e=l.length?await minify[f](l.toString()):"":["jpeg","jpg","png","webp","gif","avif"].includes(f)&&({width:u,height:h}=await(c=require("sharp")(e)).metadata(),p=u/h,a.file(m,"data:"+mime.getType(m)+";base64,"+(await c.resize({width:100*p,height:100/p}).toBuffer()).toString("base64")))}catch(e){printer.dev.fail("Failed to build: "+path.join(...i,m)),printer.dev.error(e),n[0]++,t=!0}s.file(m,e),r&&r.file(m,l),t||printer.dev.debug("Built "+path.join(...i,m))}}}async build(){if(!this.dev){this.#isBuilding&&await this.#buildPromise,this.#isBuilding=!0;let t;if(this.#buildPromise=new Promise(e=>t=e),fs.existsSync(path.join(this.#dir,conf.srcFolder))){var e=Date.now(),i=[0],n=new(require("jszip")),r=(await this.#buildInternal([],i,conf.includeOriginalInBuild?n.folder("original"):null,n.folder("source"),n.folder("jsx"),n.folder("blur")),n.file("time",Date.now()+""),n.file("runtime",runtimeId+""),path.join(this.#dir,conf.srcFolder,conf.main)),r=this.jsxToJS(fs.readFileSync(r),path.extname(conf.main));if(r instanceof Error)return exit("Couldn't build the main file!",r);if(n.file("main",r),this.#firstBuild){this.#firstBuild=!1;var r=path.join(this.#dir,conf.srcFolder,conf.main),s=path.extname(r),o=[".jsx",".tsx"];if(!o.includes(s))return exit("Invalid file extension for the main file: "+s+", expected: "+o.join(" or "));if(!fs.statSync(r).isFile())return exit("Main file not found: "+r)}fs.writeFileSync(path.join(this.#dir,".build"),await n.generateAsync({type:"nodebuffer"}));s=Date.now()-e;0===i[0]?printer.dev.pass("Built. (%c"+timeForm(s)+"&t)","color: orange"):printer.dev.fail("Built with %c"+i[0]+"&t error"+(1<i[0]?"s":"")+". (%c"+timeForm(s)+"&t)","color: blue","color: blue")}else printer.dev.warn("Skipping building since there is no %c/"+conf.srcFolder+"&t folder...","color: orange");this.#isBuilding=!1,t(),this.#buildCache||_argv_["just-build"]||await this.scanBuild()}}async scanBuild(){if(!this.dev){this.#isBuilding&&await this.waitBuild(),this.#isScanningBuild&&await this.waitBuildScanning(),fs.existsSync(path.join(this.#dir,".build"))||await this.build(),this.#isScanningBuild=!0,this.#buildCache={},this.#blurCache={},this.#jsxCache={},this.#builtJSXCache={},this.#builtJSXPage={};let t;this.#scanPromise=new Promise(e=>t=e);var e=Date.now(),s=new(require("jszip"));await s.loadAsync(fs.readFileSync(path.join(this.#dir,".build")));let i,n,r;for(const d in s.files){var o=s.files[d];if(!o.dir){let e=await o.async("nodebuffer");if("time"===d)i=+e.toString();else if("runtime"===d)n=e.toString();else if("main"===d)this.#firstScan&&(this.#firstScan=!0,r=e);else if(d.startsWith("source/")){o=d.substring(7);if(d.endsWith(".jsx")||d.endsWith(".tsx")){e=e.toString();var a,l="jsx/"+d.substring(7,d.length-4)+".json";try{a=JSON.parse(await s.files[l].async("string")),await this.#pseudoBuildJSX(o,e,a,this.#initFunctions)}catch(e){printer.dev.warn("Couldn't scan JSX: '"+o+"', meta file is missing or corrupted. Try rebuilding."),printer.dev.error(e)}}else this.#buildCache[o]=e}else d.startsWith("blur/")&&(l=d.substring(5),this.#blurCache[l]="data:"+mime.getType(l)+";base64,"+Buffer.from(e).toString("base64"))}}return i?n?(e=Date.now()-e,printer.dev.pass("Scanned the build. (%c"+timeForm(e)+"&t)","color: orange"),this.#isScanningBuild=!1,this.#builtAt=i,this.#buildRuntimeId=n,r&&await this.processMain(r),t(),void(this.#listening||!conf.listen||_argv_["just-build"]||await this.listen())):exit("Invalid build: No runtime ID found for the build! Try rebuilding."):exit("Invalid build: No timestamp found! Try rebuilding.")}!this.#listening&&conf.listen&&await this.listen()}async#pseudoBuildJSX(t,e,i,n){let r=e;i||(i=await this.readClientJSX(t,e),r=i.code);const s=(this.#jsxFunctions[t]=i).clientFunctionList;return n.push(...i.serverInit.map(e=>Function(""+makeBeginCode(null,s,JSON.stringify(path.join(t)))+e.code+`;${e.name}();`))),this.#buildCache||(this.#buildCache={}),this.#buildCache[t]=r,i}#addImport(n,t,i){if(this.#importMap[n])return t&&this.#importMap[n].push(t);var e=path.join(this.#dir,"node_modules",n);if(!fs.existsSync(e))return i.push(n);var{dependencies:e,main:r}=require(path.join(e,"package.json"));this.#importMap[n]={};const s=t=>{const i=path.join(this.#dir,"node_modules",n,t);fs.readdirSync(i).forEach(e=>{fs.statSync(path.join(i,e)).isFile()?this.#importMap[n][t+(t?"/":"")+e]=fs.readFileSync(path.join(i,e)):s(t+(t?"/":"")+e)})};s(""),this.#importMains[n]=r,Object.keys(e).forEach(e=>this.#addImport(e,t,i))}async processMain(e){if("object"==typeof(e=e instanceof Buffer?e.toString():e))return printer.dev.error(e),process.exit();const t=global["R"+(this.#buildRuntimeId||runtimeId)]=(...e)=>require("preact").createElement(...e);Hizzy.Routes=global.Routes=()=>t("div",null),Hizzy.Route=global.Route=()=>t("div",null);let i;var n=path.dirname(path.join(this.#dir,conf.srcFolder,conf.main));const r=path.join(n,"t"+random()+"--"+path.basename(conf.main)+"--.js"),s=path.join(n,"package.json");let o;var a,n=()=>{fs.existsSync(r)&&fs.rmSync(r,{recursive:!0}),!1!==o&&(o?fs.writeFileSync(s,o):fs.rmSync(s,{recursive:!0}))};try{fs.existsSync(s)?"module"===(a=JSON.parse(o=fs.readFileSync(s,"utf8"))).type!==conf.mainModule?(conf.mainModule?a.type="module":delete a.type,fs.writeFileSync(s,JSON.stringify(a))):o=!1:fs.writeFileSync(s,conf.mainModule?'{"type":"module"}':"{}"),fs.writeFileSync(r,e),i=await import(url.pathToFileURL(r))}catch(e){return n(),printer.dev.error(e),process.exit()}if(n(),!i||!(i=i.default))return exit("Expected a valid 'export default' from the main file.");if(i.type!==Routes)return exit("Expected the 'export default' from the main file to be a Routes component!");const l={},d=async(i,n="")=>{if("object"!=typeof i||Array.isArray(i))for(const e of i)await d(e,n);else{if(i.type!==Route)return exit("Expected every child component of the Routes component to be a Route component!");var r=path.join(n,i.props.path||"").replaceAll(path.sep,"/");if(i.props.children&&await d(i.props.children,r),!i.props.path)return;if(l[r])return exit("Cannot add multiple routes to the same endpoint: "+r);var s=path.join(i.props.route||"");let e=i.props.allow,t=(void 0===e&&(e="*"),i.props.deny);void 0===t&&(t=[]);var o="Route '"+s+"'s 'allow' property is invalid, expected \"*\" or an array of strings, got: ";if("string"==typeof e){if("*"!==e)return exit(o,e)}else if("object"!=typeof e||!Array.isArray(e)||e.some(e=>"string"!=typeof e))return exit(o,e);o="Route '"+s+"'s 'deny' property is invalid, expected \"*\" or an array of strings, got: ";if("string"==typeof t){if("*"!==t)return exit(o,t)}else if("object"!=typeof t||!Array.isArray(t)||t.some(e=>"string"!=typeof e))return exit(o,t);void(l[r]={route:s,routeJSON:JSON.stringify(s),allow:e,deny:t,onRequest:i.props.onRequest,method:(i.props.method||"get").toLowerCase()})}};i.props.children&&await d(i.props.children),this.routes=l;var c=["all","get","post","put","delete","patch","options","head"];for(const url in this.routes){const{route:u,method:h,routeJSON:p,allow:f,deny:m,onRequest:_}=this.routes[url];c.includes(h)?this.app[h](url,async(t,i)=>{t._Route=u,t._RouteJSON=p,t._Allow=f,t._Deny=m;let n=async()=>{this.dev?this.#devRender(u,t,i):await this.#buildRender(u,t,i)};if("function"==typeof _)_(t,i,n);else if("object"==typeof _&&Array.isArray(_)){const r=e=>{if(e===_.length)return n();_[r](t,i,()=>r(e+1))};await r(0)}else await n()}):printer.dev.warn("Invalid method: "+h+", expected one of these: "+c.join(", "))}this.app.get("*",(e,t)=>this.#staticRender(e,t))}async readClientJSX(e,t){if(e===conf.main)return{code:'throw "Cannot access the main file.";',serverFunctions:{},clientFunctionList:[],serverInit:[],joinEvent:[],leaveEvent:[],clientLoadFunctionList:[]};const i=this.jsxToJS(t,path.extname(e));if(i instanceof Error)throw i;t=babelParser.parse(i,{sourceType:"module"});const l={},d=[],c=[],u=[],h=[],p=[];let n=i,r=0;const f=({start:e,end:t},i)=>{n=n.substring(0,e+r)+i+n.substring(t+r),r+=e-t+i.length},m={},_=({start:e,end:t})=>i.substring(e,t),g=JSON.stringify(e),s=(e,t,i,n,r)=>{for(const o of i)for(const a of o.value.split("\n")){var s=a.replaceAll("*","").trim();if(["@server","@server/respond"].includes(s))f({start:e,end:t},`const ${n}=FN${runtimeId}("${n}");`),l[n]="@server"===s?{r:!1,code:r,start:e,end:t}:{r:!0,code:r,start:e,end:t};else if(["@server/start","@server/join","@server/leave"].includes(s))f({start:e,end:t},""),("@server/start"===s?u:"@server/join"===s?h:p).push({name:n,code:r,start:e,end:t});else{if("@client/render"!==s)continue;c.push(n),d.push(n)}return}d.push(n)};traverse(t,{FunctionDeclaration:({node:e})=>{var t=e["leadingComments"];e.id&&(t?s(e.start,e.end,t,e.id.name,_(e)):d.push(e.id.name))},ImportDeclaration:({node:e})=>{if("ImportDeclaration"===e.type){var i=_(e.source),n=`await H${runtimeId}.I${runtimeId}(${i},${g});`;m[i]||(m[i]=n);let t="";if(0===e.specifiers.length)m[i]===n&&(t+=n);else{var r={ImportDefaultSpecifier:[],ImportSpecifier:[],ImportNamespaceSpecifier:[]};for(const d of e.specifiers){var s=_(d.local),o=d.imported?_(d.imported):s;r[d.type].push([s,o])}if(0!==r.ImportNamespaceSpecifier.length){var a=r.ImportNamespaceSpecifier[0][0];t+=`const ${a}=${m[i]};`,a.length<m[i].length&&(m[i]=a);for(let e=1;e<r.ImportNamespaceSpecifier.length;e++)t+=`const ${r.ImportNamespaceSpecifier[e][0]}=${a};`}if(0!==r.ImportDefaultSpecifier.length){var l=r.ImportDefaultSpecifier[0][0];t+=`const{default:${l}}=${m[i]};`;for(let e=1;e<r.ImportDefaultSpecifier.length;e++)t+=`const ${r.ImportDefaultSpecifier[e][0]}=${l};`}0!==r.ImportSpecifier.length&&(t+=`const{${r.ImportSpecifier.map(([e,t])=>e===t?""+e:t+":"+e).join(",")}}=${m[i]};`)}f(e,t)}},Import:({parent:e})=>{var t;"CallExpression"===e.type&&1<=e.arguments.length&&(t=_(e.arguments[0]),f(e,m[t]||`await H${runtimeId}.I${runtimeId}(${t},${g});`))},ExportDefaultDeclaration:({node:e})=>{var t=_(e.declaration);f(e,`H${runtimeId}.E${runtimeId}[${g}].default=${t};`)},ExportNamedDeclaration:({node:e})=>{const t=`H${runtimeId}.E${runtimeId}[${g}]`;let i="";if(e.declaration){const r=e.declaration.kind;for(const s of e.declaration.declarations){var n=_(s.init);if("Identifier"===s.id.type)i+=`Object.defineProperty(${t},"${s.id.name}",{get:()=>${n}});`;else{const o=[],a=e=>"Identifier"===e.type?o.push(e.name):"ArrayPattern"===e.type?e.elements.forEach(a):"ObjectPattern"===e.type?e.properties.forEach(e=>a(e.value)):void exit("Not defined export.left type: "+e.type+", please report this behavior.");a(s.id),i+=`await (async()=>{let ${n}=${_(s.id)};${o.map(e=>"const"===r?`Object.defineProperty(${t},"${e}",{get:()=>${e}})`:t+`.${e}=`+e).join(";")}})();`}}}else for(const l of e.specifiers)i+=t+`.${_(l.local)}=${_(l.exported)};`;f(e,i)},VariableDeclaration:({node:{declarations:e,leadingComments:t,kind:i}})=>{if(e&&t&&t.length)for(const r of e){var n=r["init"];["ArrowFunctionExpression","FunctionExpression"].includes(n.type)&&(t?s(r.start-i.length-1,r.end,t,r.id.name,i+" "+_(r)):d.push(r.id.name))}}});e=this.dev?n:require("uglify-js").minify(n,{module:!0,compress:{toplevel:!1},keep_fnames:!0});if(e.error)throw e.error;return{code:"string"==typeof e?e:e.code,serverFunctions:l,clientFunctionList:d,serverInit:u,joinEvent:h,leaveEvent:p,clientLoadFunctionList:c}}async waitBuild(){return this.#buildPromise}async waitBuildScanning(){return this.#scanPromise}async sendEvalTo(e,t){e=this.#clients[e];if(!e)return!1;var i=this.#evalId++;e._send(SERVER2CLIENT.CLIENT_FUNCTION_REQUEST+i+":"+t);let n;e=new Promise(e=>n=e),this.#evalResponses[i]=n,t=await e;return delete this.#evalResponses[i],t}clientUUIDs(){return Object.keys(this.#clients)}async broadcastEval(e){var t={};for(const i of this.clientUUIDs())t[i]=await this.sendEvalTo(i,e);return t}getHash(e){return this.#hashes[e]||null}findClient(e){e=this.#clients[e];return e?new Client(e):null}findSocket(e){return this.#clients[e]||null}get directory(){return this.#dir}makeClientFunction(e,t,i=null){return makeClientFunction(e,t,i)}getAddons(){return Addon.addons}getAddon(e){return Addon.addons[e]||null}jsxToJS(e,t){try{return babel.transformSync(e,{filename:t,presets:[[require("@babel/preset-react"),{pragma:"R"+runtimeId,pragmaFrag:"F"+runtimeId}],...".tsx"===t?[require("@babel/preset-typescript")]:[]]}).code}catch(e){return e}}getCookie(e,t){e=(e||"").split(";").map(e=>e.trim()).find(e=>e.startsWith(t+"="));return e?e.substring(t.length+1):null}}module.exports=API;